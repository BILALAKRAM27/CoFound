{% extends 'base.html' %}

{% block title %}Funding Round Details - CoFound{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="mb-0">{{ round.round_name }}</h3>
                        <span class="badge 
                            {% if round.status == 'active' %}bg-primary
                            {% elif round.status == 'successful' %}bg-success
                            {% else %}bg-danger{% endif %}">
                            {{ round.status|title }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="text-muted small">Startup:</span>
                        <strong>
                            <a href="{% url 'entrepreneurs:profile_detail' round.startup.entrepreneur.id %}" class="text-decoration-none text-primary fw-bold">
                                {{ round.startup.name }}
                                <i class="bi bi-arrow-up-right ms-1" style="font-size: 0.8em;"></i>
                            </a>
                        </strong>
                    </div>
                    <div class="mb-2">
                        <span class="text-muted small">Goal:</span>
                        <strong>${{ round.target_goal|floatformat:0 }}</strong>
                        <span class="mx-2">|</span>
                        <span class="text-muted small">Equity Offered:</span>
                        <strong>{{ round.equity_offered }}%</strong>
                        <span class="mx-2">|</span>
                        <span class="text-muted small">Deadline:</span>
                        <strong>{{ round.deadline|date:'M d, Y' }}</strong>
                    </div>
                    <div class="mb-3">
                        <span class="text-muted small">Raised:</span>
                        <strong>${{ round.total_committed|floatformat:0 }}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar {% if round.percent_raised >= 100 %}bg-success{% elif round.percent_raised >= 75 %}bg-info{% else %}bg-primary{% endif %}"
                            role="progressbar" style="width: {{ round.percent_raised|floatformat:0 }}%" aria-valuenow="{{ round.percent_raised|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        {% if user.role == 'investor' and round.status == 'active' %}
                            <button class="btn btn-primary flex-grow-1" data-bs-toggle="modal" data-bs-target="#commitModal">
                                <i class="bi bi-currency-dollar me-1"></i>Commit Investment
                            </button>
                        {% endif %}
                        {% if user.role == 'entrepreneur' and round.status == 'active' %}
                            <button type="button" class="btn btn-danger flex-grow-1" id="closeRoundBtn">
                                <i class="bi bi-x-circle me-1"></i>Close Round
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">Investor Commitments</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Investor</th>
                                    <th>Amount</th>
                                    <th>Equity %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in commitments %}
                                <tr>
                                                                     <td>{{ c.investor.get_full_name|default:c.investor.email }}</td>
                                 <td>${{ c.amount|floatformat:0 }}</td>
                                 <td>{{ c.safe_equity_share|floatformat:2 }}%</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No commitments yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Commit Investment Modal -->
    <div class="modal fade" id="commitModal" tabindex="-1" aria-labelledby="commitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <form id="commitInvestmentForm">
                    {% csrf_token %}
                    <input type="hidden" name="funding_round_id" value="{{ round.id }}">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="commitModalLabel">Commit Investment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (USD)</label>
                            <input type="number" class="form-control" name="amount" id="amount" min="1" required>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="submit" class="btn btn-primary w-100" id="commitBtn">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                            Commit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="notificationContent"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const commitForm = document.getElementById('commitInvestmentForm');
    const commitBtn = document.getElementById('commitBtn');
    const commitModal = document.getElementById('commitModal');
    const closeRoundBtn = document.getElementById('closeRoundBtn');
    const notificationModal = document.getElementById('notificationModal');
    const notificationContent = document.getElementById('notificationContent');
    
    commitForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const spinner = commitBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        commitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(commitForm);
        
        // Submit via AJAX
        fetch('{% url "investors:commit_investment" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                // Try to get error details from response
                return response.json().then(errorData => {
                    const errorMessage = errorData.error || 'Unknown error';
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorMessage}`);
                }).catch(() => {
                    throw new Error(`HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // Hide loading state
            spinner.classList.add('d-none');
            commitBtn.disabled = false;
            
            // Close commit modal
            const commitModalInstance = bootstrap.Modal.getInstance(commitModal);
            commitModalInstance.hide();
            
            // Show notification
            if (data.success) {
                notificationContent.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-success">Investment Committed Successfully!</h5>
                        <p class="text-muted">Your investment of $${parseFloat(data.amount).toLocaleString()} has been committed.</p>
                        <p class="text-muted">You will receive ${data.equity_share}% equity if the round is successful.</p>
                    </div>
                `;
            } else {
                notificationContent.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-warning">Investment Failed</h5>
                        <p class="text-muted">${data.error}</p>
                    </div>
                `;
            }
            
            // Show notification modal
            const notificationModalInstance = new bootstrap.Modal(notificationModal);
            notificationModalInstance.show();
            
            // Reload page on success to show updated data
            if (data.success) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            // Hide loading state
            spinner.classList.add('d-none');
            commitBtn.disabled = false;
            
            // Close commit modal
            const commitModalInstance = bootstrap.Modal.getInstance(commitModal);
            commitModalInstance.hide();
            
            // Show error notification with more details
            let errorMessage = 'An unexpected error occurred. Please try again.';
            if (error.message && error.message.includes('HTTP error')) {
                errorMessage = 'Server error. Please try again or contact support if the problem persists.';
            }
            
            notificationContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-danger">Error</h5>
                    <p class="text-muted">${errorMessage}</p>
                    <small class="text-muted">Error details: ${error.message}</small>
                </div>
            `;
            
            // Show notification modal
            const notificationModalInstance = new bootstrap.Modal(notificationModal);
            notificationModalInstance.show();
        });
    });
    
    // Handle close round button
    if (closeRoundBtn) {
        closeRoundBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to close this funding round? This action cannot be undone.')) {
                // Show loading state
                closeRoundBtn.disabled = true;
                closeRoundBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Closing...';
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Submit via AJAX
                fetch('{% url "investors:close_funding_round" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: `funding_round_id={{ round.id }}`
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    closeRoundBtn.disabled = false;
                    closeRoundBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Close Round';
                    
                    // Show notification
                    if (data.success) {
                        notificationContent.innerHTML = `
                            <div class="text-center">
                                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-success">Funding Round Closed!</h5>
                                <p class="text-muted">The funding round has been marked as <strong>${data.status}</strong>.</p>
                            </div>
                        `;
                    } else {
                        notificationContent.innerHTML = `
                            <div class="text-center">
                                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-warning">Failed to Close Round</h5>
                                <p class="text-muted">${data.error}</p>
                            </div>
                        `;
                    }
                    
                    // Show notification modal
                    const notificationModalInstance = new bootstrap.Modal(notificationModal);
                    notificationModalInstance.show();
                    
                    // Reload page on success to show updated status
                    if (data.success) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                })
                .catch(error => {
                    // Reset button state
                    closeRoundBtn.disabled = false;
                    closeRoundBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Close Round';
                    
                    // Show error notification
                    notificationContent.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-danger">Error</h5>
                            <p class="text-muted">An unexpected error occurred. Please try again.</p>
                        </div>
                    `;
                    
                    // Show notification modal
                    const notificationModalInstance = new bootstrap.Modal(notificationModal);
                    notificationModalInstance.show();
                });
            }
        });
    }
});
</script>
{% endblock %}
