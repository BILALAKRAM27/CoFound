{% extends 'base.html' %}

{% block title %}Create Funding Round - CoFound{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="row g-4 align-items-stretch">
                <!-- Form -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-transparent border-0">
                            <h4 class="mb-0">Create Funding Round</h4>
                        </div>
                        <div class="card-body">
                            {% if errors %}
                                {% for field, error in errors.items %}
                                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                        {{ error }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if not user_startups %}
                                <div class="alert alert-warning" role="alert">
                                    <h6 class="alert-heading">No Startup Profile Found</h6>
                                    <p class="mb-2">You need to create a startup profile before you can create a funding round.</p>
                                    <a href="{% url 'entrepreneurs:create_startup' %}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-plus-circle me-1"></i>Create Startup
                                    </a>
                                </div>
                            {% else %}
                                <form id="fundingRoundForm" method="post" autocomplete="off">
                                    {% csrf_token %}
                                    
                                                                         {% if user_startups.count > 1 %}
                                         <div class="mb-3">
                                             <label for="startup_id" class="form-label">Select Startup *</label>
                                             <select class="form-select" id="startup_id" name="startup_id" required>
                                                 <option value="">Choose a startup...</option>
                                                 {% for startup in user_startups %}
                                                     <option value="{{ startup.id }}" {% if initial.startup_id == startup.id|stringformat:"s" or not initial.startup_id and forloop.first %}selected{% endif %}>
                                                         {{ startup.name }} ({{ startup.industry }})
                                                     </option>
                                                 {% endfor %}
                                             </select>
                                         </div>
                                     {% else %}
                                         <input type="hidden" name="startup_id" value="{{ user_startups.0.id }}">
                                         <div class="mb-3">
                                             <label class="form-label">Startup</label>
                                             <div class="form-control-plaintext">{{ user_startups.0.name }} ({{ user_startups.0.industry }})</div>
                                         </div>
                                     {% endif %}
                                    
                                    <div class="mb-3">
                                        <label for="round_name" class="form-label">Round Name</label>
                                        <input type="text" class="form-control" id="round_name" name="round_name" maxlength="255" 
                                               value="{{ initial.round_name|default:'' }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="target_goal" class="form-label">Target Goal (USD)</label>
                                        <input type="number" class="form-control" id="target_goal" name="target_goal" min="1" 
                                               value="{{ initial.target_goal|default:'' }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="equity_offered" class="form-label">Equity Offered (%)</label>
                                        <input type="number" class="form-control" id="equity_offered" name="equity_offered" min="0.01" max="100" step="0.01" 
                                               value="{{ initial.equity_offered|default:'' }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="deadline" class="form-label">Deadline</label>
                                        <input type="datetime-local" class="form-control" id="deadline" name="deadline" 
                                               value="{{ initial.deadline|default:'' }}" 
                                               min="{{ 'now'|date:'Y-m-d\TH:i' }}" required>
                                        <div class="form-text">Select a future date and time for the funding round deadline.</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">Create Round</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Preview -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-transparent border-0">
                            <h4 class="mb-0">Preview</h4>
                        </div>
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <div id="previewCard" class="w-100">
                                <div class="card border-0 shadow rounded-4">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5 class="card-title mb-0" id="previewRoundName">Round Name</h5>
                                            <span class="badge bg-primary" id="previewStatus">Active</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted small">Goal:</span>
                                            <strong id="previewGoal">$0</strong>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted small">Equity Offered:</span>
                                            <strong id="previewEquity">0%</strong>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted small">Deadline:</span>
                                            <strong id="previewDeadline">-</strong>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted small">Startup:</span>
                                            <strong id="previewStartup">-</strong>
                                        </div>
                                        <div class="mt-3">
                                            <span class="text-muted small">Summary:</span>
                                            <div class="fw-semibold" id="previewSummary">Looking for $0 in exchange for 0% equity.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function formatMoney(val) {
    if (!val) return '$0';
    return '$' + Number(val).toLocaleString();
}
function formatDateTime(dt) {
    if (!dt) return '-';
    try {
        const d = new Date(dt);
        return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    } catch { return dt; }
}
function updatePreview() {
    const name = document.getElementById('round_name').value || 'Round Name';
    const goal = document.getElementById('target_goal').value;
    const equity = document.getElementById('equity_offered').value;
    const deadline = document.getElementById('deadline').value;
    
    // Handle startup selection
    const startupSelect = document.getElementById('startup_id');
    let startupName = '-';
    if (startupSelect) {
        const selectedOption = startupSelect.options[startupSelect.selectedIndex];
        startupName = selectedOption ? selectedOption.text : '-';
    } else {
        // If no select, check for the hidden input and display startup info
        const startupDisplay = document.querySelector('.form-control-plaintext');
        if (startupDisplay) {
            startupName = startupDisplay.textContent.trim();
        }
    }
    
    document.getElementById('previewRoundName').textContent = name;
    document.getElementById('previewGoal').textContent = formatMoney(goal);
    document.getElementById('previewEquity').textContent = equity ? equity + '%' : '0%';
    document.getElementById('previewDeadline').textContent = formatDateTime(deadline);
    document.getElementById('previewStartup').textContent = startupName;
    document.getElementById('previewSummary').textContent = `Looking for ${formatMoney(goal)} in exchange for ${equity || 0}% equity.`;
}

// Add event listeners for all form fields
['round_name','target_goal','equity_offered','deadline'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
        element.addEventListener('input', updatePreview);
    }
});

// Add event listener for startup selection if it exists
const startupSelect = document.getElementById('startup_id');
if (startupSelect) {
    startupSelect.addEventListener('change', updatePreview);
}

updatePreview();
</script>
{% endblock %}
