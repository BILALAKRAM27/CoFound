{% extends 'base.html' %}
{% load profile_filters %}

{% block title %}{{ profile_user.get_full_name|default:profile_user.email }} - Profile | CoFound{% endblock %}

{% block styles %}
<style>
    /* Match home/saved_posts post + comment styles */
    .feed-container { max-width: 100%; margin: 0 auto; padding: 0; }

    .post-card { background: var(--bs-body-bg); border: none; border-radius: 16px; box-shadow: var(--cf-card-shadow); margin-bottom: 2rem; overflow: hidden; transition: all 0.3s ease; }
    .post-card:hover { box-shadow: var(--cf-card-shadow-hover); transform: translateY(-2px); }

    .post-header { padding: 1.25rem 1.5rem 0; display: flex; align-items: center; gap: 1rem; }
    .post-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--cf-sidebar-border); }
    .post-meta h6 { margin: 0; font-weight: 600; color: var(--cf-text-primary); display: flex; align-items: center; gap: 0.5rem; }
    .post-meta small { color: var(--cf-text-secondary); font-size: 0.875rem; }

    .post-body { padding: 1rem 1.5rem; }
    .post-content { color: var(--cf-text-primary); line-height: 1.6; margin-bottom: 1rem; }

    .post-footer { padding: 0.75rem 1.5rem 1.25rem; border-top: 1px solid var(--cf-sidebar-border); display: flex; gap: 1rem; }
    .post-action { background: none; border: none; color: var(--cf-text-secondary); padding: 0.5rem 1rem; border-radius: 25px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
    .post-action:hover { background-color: rgba(30, 58, 138, 0.1); color: var(--cf-primary); transform: translateY(-1px); }
    .post-action.liked { color: #dc2626; }

    .comment-section { background-color: var(--cf-sidebar-bg); padding: 1rem 1.5rem; border-top: 1px solid var(--cf-sidebar-border); }
    .comment { background: var(--bs-body-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--cf-sidebar-border); }
    .comment-form { margin-top: 1rem; }

    /* Media Gallery Styles (with blur overlay) */
    .media-gallery { margin: 1rem 0; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; }
    .media-gallery:hover { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }

    .media-gallery-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; height: 300px; }

    .media-main { position: relative; overflow: hidden; border-radius: 12px; background: var(--cf-sidebar-bg); }
    .media-main img, .media-main video { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }

    .media-main-doc { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: var(--cf-sidebar-bg); border: 2px dashed var(--cf-sidebar-border); border-radius: 12px; color: var(--cf-text-secondary); }
    .media-main-doc i { font-size: 3rem; margin-bottom: 0.5rem; color: var(--cf-primary); }
    .media-main-doc span { font-size: 0.875rem; text-align: center; max-width: 80%; word-break: break-word; }

    .media-secondary { display: flex; flex-direction: column; gap: 8px; }
    .media-secondary-item { flex: 1; position: relative; overflow: hidden; border-radius: 8px; background: var(--cf-sidebar-bg); }
    .media-secondary-item img, .media-secondary-item video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

    .media-secondary-doc { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: var(--cf-sidebar-bg); border: 2px dashed var(--cf-sidebar-border); border-radius: 8px; color: var(--cf-text-secondary); }
    .media-secondary-doc i { font-size: 1.5rem; color: var(--cf-primary); }

    .media-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; backdrop-filter: blur(4px); border-radius: 12px; }
    .media-count { background: rgba(0, 0, 0, 0.8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 1rem; font-weight: 600; }

    /* Single media item */
    .media-single { margin: 1rem 0; border-radius: 12px; overflow: hidden; max-height: 400px; }
    .media-single img, .media-single video { width: 100%; height: auto; max-height: 400px; object-fit: cover; border-radius: 12px; }

    .media-single-doc { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--cf-sidebar-bg); border: 2px dashed var(--cf-sidebar-border); border-radius: 12px; color: var(--cf-text-secondary); }
    .media-single-doc i { font-size: 2rem; color: var(--cf-primary); }
    .media-single-doc span { font-size: 1rem; font-weight: 500; }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .feed-container { max-width: 100%; padding: 0 0.5rem; }
        .media-gallery-grid { grid-template-columns: 1fr; height: auto; }
        .media-main { height: 250px; }
        .media-secondary { flex-direction: row; }
        .media-secondary-item { height: 120px; }
    }

    /* Dark mode adjustments */
    [data-bs-theme="dark"] .post-card { background-color: #374151; color: var(--cf-text-primary); }
    [data-bs-theme="dark"] .post-footer { border-top-color: #4b5563; }
    [data-bs-theme="dark"] .comment-section { background-color: #1f2937; }
    [data-bs-theme="dark"] .comment { background-color: #374151; border-color: #4b5563; }
    [data-bs-theme="dark"] .media-main-doc, [data-bs-theme="dark"] .media-secondary-doc { background-color: #1f2937; border-color: #4b5563; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid content-container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card mb-4 shadow-sm">
                <div class="card-body d-flex flex-column flex-md-row align-items-center">
                    <div class="me-md-4 mb-3 mb-md-0 text-center">
                        {% if profile.image %}
                            <img src="data:image/jpeg;base64,{{ profile.image|b64encode_blob }}" class="rounded-circle border border-3 border-primary" width="120" height="120" alt="Profile Picture">
                        {% else %}
                            <i class="fa fa-user-circle fa-5x text-secondary"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h3 class="mb-1 d-flex align-items-center gap-2">
                            <span>{{ profile_user.get_full_name|default:profile_user.email }}</span>
                            <span class="badge bg-primary"><i class="fa fa-user"></i> {{ profile_user.role|title }}</span>
                        </h3>
                        <div class="mb-2">
                            {% if profile.bio %}
                                <i class="fa fa-info-circle me-1 text-accent"></i> <span>{{ profile.bio }}</span>
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            {% if profile.location %}
                                <i class="fa fa-map-marker me-1 text-success"></i> {{ profile.location }}
                            {% endif %}
                            {% if profile_user.role == 'entrepreneur' and profile.industries %}
                              <span class="ms-3"><i class="fa fa-tags me-1 text-warning"></i>{{ profile.industries }}</span>
                            {% elif profile_user.role == 'investor' and profile.preferred_industries %}
                              <span class="ms-3"><i class="fa fa-tags me-1 text-warning"></i>{{ profile.preferred_industries }}</span>
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            {% if profile_user.role == 'entrepreneur' and profile.company_name %}
                                <i class="fa fa-building me-1 text-primary"></i> {{ profile.company_name }}
                            {% elif profile_user.role == 'investor' and profile.firm_name %}
                                <i class="fa fa-briefcase me-1 text-primary"></i> {{ profile.firm_name }}
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            {% if profile_user.role == 'entrepreneur' and profile.website %}
                                <a href="{{ profile.website }}" target="_blank" class="me-2"><i class="fa fa-globe me-1 text-info"></i>Website</a>
                            {% elif profile_user.role == 'investor' and profile.website %}
                                <a href="{{ profile.website }}" target="_blank" class="me-2"><i class="fa fa-globe me-1 text-info"></i>Website</a>
                            {% endif %}
                            {% if profile.linkedin_url %}
                                <a href="{{ profile.linkedin_url }}" target="_blank"><i class="fa fa-linkedin-square me-1 text-primary"></i>LinkedIn</a>
                            {% endif %}
                        </div>
                        {% if profile_user.role == 'entrepreneur' %}
                        <div class="mb-2">
                            {% if profile.startup_description %}
                                <i class="fa fa-lightbulb-o me-1 text-warning"></i> {{ profile.startup_description }}
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            <i class="fa fa-users me-1 text-secondary"></i> Team Size: {{ profile.team_size|default:'N/A' }}
                            <span class="ms-3"><i class="fa fa-money me-1 text-success"></i> Funding Raised: {{ profile.funding_raised|default:'N/A' }}</span>
                        </div>
                        <div class="mb-2">
                            <i class="fa fa-line-chart me-1 text-info"></i> Revenue: {{ profile.revenue|default:'N/A' }}
                            <span class="ms-3"><i class="fa fa-balance-scale me-1 text-accent"></i> Valuation: {{ profile.valuation|default:'N/A' }}</span>
                        </div>
                        {% elif profile_user.role == 'investor' %}
                        <div class="mb-2">
                            <i class="fa fa-bar-chart me-1 text-info"></i> Investment Stage: {{ profile.get_investment_stage_display|default:'N/A' }}
                            <span class="ms-3"><i class="fa fa-money me-1 text-success"></i> Investment Size: {{ profile.get_investment_size_display|default:'N/A' }}</span>
                        </div>
                        <div class="mb-2">
                            <i class="fa fa-briefcase me-1 text-primary"></i> Portfolio: {{ profile.portfolio_companies|default:'N/A' }}
                        </div>
                        <div class="mb-2">
                            <i class="fa fa-trophy me-1 text-warning"></i> Notable Exits: {{ profile.notable_exits|default:'N/A' }}
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            {% if not is_self %}
                                {% with status=user|connection_status:profile_user %}
                                    <button class="{% if status == 'accepted' %}following-btn{% else %}follow-btn{% endif %} connect-toggle me-2" data-target-id="{{ profile_user.id }}">
                                        {% if status == 'accepted' %}<i class="fa fa-check" aria-hidden="true"></i> Following{% else %}<i class="fa fa-plus" aria-hidden="true"></i> Follow{% endif %}
                                    </button>
                                {% endwith %}
                                <!-- Message Button -->
                                <button class="btn btn-outline-secondary" onclick="openMessageChat('{{ profile_user.id }}', '{{ profile_user.role }}')">
                                    <i class="fa fa-commenting me-1"></i>Message
                                </button>
                                <!-- Schedule Meeting Button -->
                                <a href="{% if user.is_authenticated and user.role == 'entrepreneur' %}{% url 'entrepreneurs:schedule_meeting' profile_user.id %}{% else %}{% url 'investors:schedule_meeting' profile_user.id %}{% endif %}" class="btn btn-primary">
                                    <i class="fa fa-calendar-plus me-1"></i>Schedule Meeting
                                </a>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{% if profile_user.role == 'entrepreneur' %}{% url 'entrepreneurs:user_network' profile_user.id %}{% else %}{% url 'investors:user_network' profile_user.id %}{% endif %}" class="btn btn-outline-accent btn-sm"><i class="fa fa-users me-1"></i>View Connections</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Posts Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0"><i class="fa fa-newspaper-o me-2"></i>Posts by {{ profile_user.get_full_name|default:profile_user.email }}</h5>
                </div>
                <div class="card-body">
                    <div class="feed-container">
                        {% for post in posts %}
                            {% include 'post_card.html' with post=post user=user %}
                        {% empty %}
                            <div class="text-center my-5">
                                <i class="fa fa-newspaper-o fa-2x text-muted"></i>
                                <h5 class="mt-3">No posts yet</h5>
                                <p class="text-muted">Be the first to share something with the community!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function openMessageChat(userId, userRole) {
    // Redirect to the messages page with the user ID as a parameter
    // This will open the chat with the specific user
    const currentUserRole = '{% if user.is_authenticated %}{{ user.role }}{% endif %}'; // Get current user's role
    
    if (currentUserRole === 'investor') {
        // Current user is investor, redirect to investor messages page
        window.location.href = `/investor/messages/?open_chat=${userId}`;
    } else {
        // Current user is entrepreneur, redirect to entrepreneur messages page
        window.location.href = `/entrepreneur/messages/?open_chat=${userId}`;
    }
}
</script>

{% endblock %}
