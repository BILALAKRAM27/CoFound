{% load profile_filters %}
<div class="post-card" data-post-id="{{ post.id }}">
    <div class="post-header">
        {% if post.author|get_profile_image %}
            <img src="data:image/jpeg;base64,{{ post.author|get_profile_image|b64encode_blob }}" 
                 alt="{{ post.author.get_full_name|default:post.author.email }}" class="post-avatar">
        {% else %}
            <div class="post-avatar d-flex align-items-center justify-content-center bg-secondary text-white">
                <i class="fa fa-user"></i>
            </div>
        {% endif %}
        <div class="post-meta">
            <h6>
                {{ post.author.get_full_name|default:post.author.email }}
                <span class="badge {% if post.author.role == 'entrepreneur' %}bg-success{% else %}bg-primary{% endif %} rounded-pill">
                    <i class="fa fa-user-circle"></i> {{ post.author.get_role_display|default:post.author.role|title }}
                </span>
            </h6>
            <small class="text-muted">{{ post.created_at|timesince }} ago</small>
        </div>
    </div>
    <div class="post-body">
        {% if post.content %}
            <div class="post-content">
                <p>{{ post.content }}</p>
            </div>
        {% endif %}
        <!-- Media Files Display -->
        {% if post.media_files.exists %}
            {% with media_count=post.media_files.count %}
                {% if media_count == 1 %}
                    {% with media=post.media_files.first %}
                        <div class="media-single" onclick="openMediaGallery('{{ post.id }}')">
                            {% if media.media_type == 'image' %}
                                <img src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" 
                                     alt="{{ media.file_name }}" class="img-fluid"
                                     data-file-type="{{ media.file_type }}"
                                     data-file-name="{{ media.file_name }}"
                                     data-file-data="{{ media.file_data|b64encode_blob }}">
                            {% elif media.media_type == 'video' %}
                                <video controls class="img-fluid"
                                       data-file-type="{{ media.file_type }}"
                                       data-file-name="{{ media.file_name }}"
                                       data-file-data="{{ media.file_data|b64encode_blob }}">
                                    <source src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" type="{{ media.file_type }}">
                                    Your browser does not support the video tag.
                                </video>
                            {% elif media.media_type == 'document' %}
                                <div class="media-single-doc"
                                     data-file-type="{{ media.file_type }}"
                                     data-file-name="{{ media.file_name }}"
                                     data-file-data="{{ media.file_data|b64encode_blob }}">
                                    <i class="fa fa-file-text-o"></i>
                                    <span>{{ media.file_name }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endwith %}
                {% else %}
                    <div class="media-gallery" onclick="openMediaGallery('{{ post.id }}')">
                        <div class="media-gallery-grid">
                            <div class="media-main">
                                {% with main_media=post.media_files.first %}
                                    {% if main_media.media_type == 'image' %}
                                        <img src="data:{{ main_media.file_type }};base64,{{ main_media.file_data|b64encode_blob }}" 
                                             alt="{{ main_media.file_name }}"
                                             data-file-type="{{ main_media.file_type }}"
                                             data-file-name="{{ main_media.file_name }}"
                                             data-file-data="{{ main_media.file_data|b64encode_blob }}">
                                    {% elif main_media.media_type == 'video' %}
                                        <video muted
                                               data-file-type="{{ main_media.file_type }}"
                                               data-file-name="{{ main_media.file_name }}"
                                               data-file-data="{{ main_media.file_data|b64encode_blob }}">
                                            <source src="data:{{ main_media.file_type }};base64,{{ main_media.file_data|b64encode_blob }}" type="{{ main_media.file_type }}">
                                        </video>
                                    {% elif main_media.media_type == 'document' %}
                                        <div class="media-main-doc"
                                             data-file-type="{{ main_media.file_type }}"
                                             data-file-name="{{ main_media.file_name }}"
                                             data-file-data="{{ main_media.file_data|b64encode_blob }}">
                                            <i class="fa fa-file-text-o"></i>
                                            <span>{{ main_media.file_name }}</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                             </div>
                             <div class="media-secondary">
                                {% for media in post.media_files.all|slice:"1:3" %}
                                    <div class="media-secondary-item">
                                        {% if media.media_type == 'image' %}
                                            <img src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" 
                                                 alt="{{ media.file_name }}"
                                                 data-file-type="{{ media.file_type }}"
                                                 data-file-name="{{ media.file_name }}"
                                                 data-file-data="{{ media.file_data|b64encode_blob }}">
                                        {% elif media.media_type == 'video' %}
                                            <video muted
                                                   data-file-type="{{ media.file_type }}"
                                                   data-file-name="{{ media.file_name }}"
                                                   data-file-data="{{ media.file_data|b64encode_blob }}">
                                                <source src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" type="{{ media.file_type }}">
                                            </video>
                                        {% elif media.media_type == 'document' %}
                                            <div class="media-secondary-doc"
                                                 data-file-type="{{ media.file_type }}"
                                                 data-file-name="{{ media.file_name }}"
                                                 data-file-data="{{ media.file_data|b64encode_blob }}">
                                                <i class="fa fa-file-text-o"></i>
                                            </div>
                                        {% endif %}
                                        {% if forloop.first %}
                                            <div class="media-overlay">
                                                <div class="media-count">+{{ media_count }}</div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                <!-- Hidden container for all media files for gallery -->
                <div class="all-media-files" style="display:none">
                    {% for media in post.media_files.all %}
                        {% if media.media_type == 'image' %}
                            <img src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" 
                                 alt="{{ media.file_name }}"
                                 data-file-type="{{ media.file_type }}"
                                 data-file-name="{{ media.file_name }}"
                                 data-file-data="{{ media.file_data|b64encode_blob }}">
                        {% elif media.media_type == 'video' %}
                            <video muted
                                   data-file-type="{{ media.file_type }}"
                                   data-file-name="{{ media.file_name }}"
                                   data-file-data="{{ media.file_data|b64encode_blob }}">
                                <source src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" type="{{ media.file_type }}">
                            </video>
                        {% elif media.media_type == 'document' %}
                            <div class="media-main-doc"
                                 data-file-type="{{ media.file_type }}"
                                 data-file-name="{{ media.file_name }}"
                                 data-file-data="{{ media.file_data|b64encode_blob }}">
                                <i class="fa fa-file-text-o"></i>
                                <span>{{ media.file_name }}</span>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endwith %}
        {% endif %}
    </div>
    <div class="post-footer">
        <button class="post-action like-btn {% if user in post.likes.all %}liked{% endif %}" data-post-id="{{ post.id }}">
            <i class="fa {% if user in post.likes.all %}fa-heart{% else %}fa-heart-o{% endif %}"></i>
            <span class="likes-count">{{ post.likes.count }}</span>
        </button>
        <button class="post-action" data-bs-toggle="collapse" data-bs-target="#comments-{{ post.id }}">
            <i class="fa fa-comment-o"></i>
            <span>{{ post.comments.count }}</span>
        </button>
        <button class="post-action save-btn" data-post-id="{{ post.id }}" title="Save">
            {% if user in post.saved_by.all %}
                <i class="fa fa-bookmark"></i>
            {% else %}
                <i class="fa fa-bookmark-o"></i>
            {% endif %}
        </button>
    </div>
    <!-- Comments Section -->
    <div class="collapse comment-section" id="comments-{{ post.id }}">
        <div class="comments-container mb-3" style="max-height: 300px; overflow-y: auto;">
            {% for comment in post.comments.all %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <div class="d-flex align-items-center mb-2">
                        {% if comment.author|get_profile_image %}
                            <img src="data:image/jpeg;base64,{{ comment.author|get_profile_image|b64encode_blob }}" 
                                 alt="{{ comment.author.get_full_name|default:comment.author.email }}" class="rounded-circle me-2" width="32" height="32">
                        {% else %}
                            <div class="rounded-circle me-2 bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                <i class="fa fa-user" style="font-size: 0.875rem;"></i>
                            </div>
                        {% endif %}
                        <strong>{{ comment.author.get_full_name|default:comment.author.email }}</strong>
                        <small class="text-muted ms-2">{{ comment.created_at|timesince }} ago</small>
                        {% if comment.author == user %}
                            <div class="ms-auto d-flex align-items-center gap-1">
                                <button class="comment-action-btn edit edit-comment-btn" title="Edit" data-comment-id="{{ comment.id }}">
                                    <i class="fa fa-pencil-square-o"></i>
                                </button>
                                <button class="comment-action-btn delete delete-comment-btn" title="Delete" data-comment-id="{{ comment.id }}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    <p class="mb-0">{{ comment.content }}</p>
                </div>
            {% empty %}
                <div class="text-muted">No comments yet.</div>
            {% endfor %}
        </div>
        <form class="comment-form" data-post-id="{{ post.id }}">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" name="content" class="form-control" placeholder="Write a comment..." maxlength="500" required>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>
