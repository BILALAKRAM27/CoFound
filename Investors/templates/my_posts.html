{% extends 'base.html' %}
{% load profile_filters %}

{% block title %}My Posts - CoFound{% endblock %}

{% block styles %}
<style>
    /* Mirror home/saved/profile post styles */
    .feed-container { max-width: 100%; margin: 0 auto; padding: 0; }
    .post-card { background: var(--bs-body-bg); border: none; border-radius: 16px; box-shadow: var(--cf-card-shadow); margin-bottom: 2rem; overflow: hidden; transition: all 0.3s ease; }
    .post-card:hover { box-shadow: var(--cf-card-shadow-hover); transform: translateY(-2px); }
    .post-header { padding: 1.25rem 1.5rem 0; display: flex; align-items: center; gap: 1rem; }
    .post-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--cf-sidebar-border); }
    .post-meta h6 { margin: 0; font-weight: 600; color: var(--cf-text-primary); display: flex; align-items: center; gap: 0.5rem; }
    .post-meta small { color: var(--cf-text-secondary); font-size: 0.875rem; }
    .post-body { padding: 1rem 1.5rem; }
    .post-content { color: var(--cf-text-primary); line-height: 1.6; margin-bottom: 1rem; }
    .post-footer { padding: 0.75rem 1.5rem 1.25rem; border-top: 1px solid var(--cf-sidebar-border); display: flex; gap: 1rem; }
    .post-action { background: none; border: none; color: var(--cf-text-secondary); padding: 0.5rem 1rem; border-radius: 25px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
    .post-action:hover { background-color: rgba(30,58,138,.1); color: var(--cf-primary); transform: translateY(-1px); }
    .post-action.liked { color: #dc2626; }

    .comment-section { background-color: var(--cf-sidebar-bg); padding: 1rem 1.5rem; border-top: 1px solid var(--cf-sidebar-border); }
    .comment { background: var(--bs-body-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--cf-sidebar-border); }

    /* Media gallery */
    .media-gallery { margin: 1rem 0; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; }
    .media-gallery:hover { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .media-gallery-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; height: 300px; }
    .media-main { position: relative; overflow: hidden; border-radius: 12px; background: var(--cf-sidebar-bg); }
    .media-main img, .media-main video { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
    .media-main-doc { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: var(--cf-sidebar-bg); border: 2px dashed var(--cf-sidebar-border); border-radius: 12px; color: var(--cf-text-secondary); }
    .media-secondary { display: flex; flex-direction: column; gap: 8px; }
    .media-secondary-item { flex: 1; position: relative; overflow: hidden; border-radius: 8px; background: var(--cf-sidebar-bg); }
    .media-secondary-item img, .media-secondary-item video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    .media-secondary-doc { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: var(--cf-sidebar-bg); border: 2px dashed var(--cf-sidebar-border); border-radius: 8px; color: var(--cf-text-secondary); }
    .media-overlay { position: absolute; inset: 0; background: rgba(0,0,0,.6); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; backdrop-filter: blur(4px); border-radius: 12px; }
    .media-count { background: rgba(0,0,0,.8); color: #fff; padding: .5rem 1rem; border-radius: 20px; font-size: 1rem; font-weight: 600; }

    .media-single { margin: 1rem 0; border-radius: 12px; overflow: hidden; max-height: 400px; position: relative; }
    .media-single img, .media-single video { width: 100%; height: auto; max-height: 400px; object-fit: cover; border-radius: 12px; }

    /* Edit affordances */
    .editor-actions { display: flex; gap: .5rem; }
    .media-edit-badge { position: absolute; top: 8px; right: 8px; z-index: 5; }
    .draggable { cursor: grab; }
    .drag-over { outline: 2px dashed var(--cf-primary); outline-offset: -2px; }

    /* Modal media list */
    .modal-media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: .75rem; }
    .modal-media-item { position: relative; border: 1px solid var(--cf-sidebar-border); border-radius: 8px; background: var(--bs-body-bg); padding: .25rem; display: flex; align-items: center; justify-content: center; min-height: 120px; }
    .modal-media-item img, .modal-media-item video { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; }
    .modal-media-item .remove { position: absolute; top: 6px; right: 6px; }

    /* Dark mode */
    [data-bs-theme="dark"] .post-card { background-color: #374151; color: var(--cf-text-primary); }
    [data-bs-theme="dark"] .post-footer { border-top-color: #4b5563; }
    [data-bs-theme="dark"] .comment-section { background-color: #1f2937; }
    [data-bs-theme="dark"] .comment { background-color: #374151; border-color: #4b5563; }
    [data-bs-theme="dark"] .media-main-doc, [data-bs-theme="dark"] .media-secondary-doc { background-color: #1f2937; border-color: #4b5563; }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">My Posts</h4>
    <a href="{% url 'home' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Back</a>
  </div>

  <div class="feed-container">
    {% for post in posts %}
      <div class="post-card" data-post-id="{{ post.id }}">
        <div class="post-header">
          {% if post.author|get_profile_image %}
            <img src="data:image/jpeg;base64,{{ post.author|get_profile_image|b64encode_blob }}" class="post-avatar" alt="">
          {% else %}
            <div class="post-avatar d-flex align-items-center justify-content-center bg-secondary text-white"><i class="bi bi-person-fill"></i></div>
          {% endif %}
          <div class="post-meta">
            <h6>{{ post.author.get_full_name|default:post.author.email }}</h6>
            <small class="text-muted">{{ post.created_at|timesince }} ago</small>
          </div>
          <div class="ms-auto editor-actions">
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editPostModal" data-post-id="{{ post.id }}" data-post-content="{{ post.content|escape }}">
              <i class="bi bi-pencil-square me-1"></i>Edit
            </button>
          </div>
        </div>

        <div class="post-body">
          {% if post.content %}<div class="post-content"><p>{{ post.content }}</p></div>{% endif %}

          {% with media_count=post.media_files.count %}
            {% if media_count == 1 %}
              {% with media=post.media_files.first %}
                <div class="media-single" data-media-id="{{ media.id }}">
                  {% if media.media_type == 'image' %}
                    <img src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" class="img-fluid" alt="{{ media.file_name }}">
                  {% elif media.media_type == 'video' %}
                    <video controls class="img-fluid"><source src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" type="{{ media.file_type }}"></video>
                  {% else %}
                    <div class="media-single-doc"><i class="bi bi-file-earmark"></i><span>{{ media.file_name }}</span></div>
                  {% endif %}
                </div>
              {% endwith %}
            {% elif media_count > 1 %}
              <div class="media-gallery" onclick="openMediaGallery('{{ post.id }}')">
                <div class="media-gallery-grid">
                  <div class="media-main" data-media-id="{{ post.media_files.first.id }}">
                    {% with main_media=post.media_files.first %}
                      {% if main_media.media_type == 'image' %}
                        <img src="data:{{ main_media.file_type }};base64,{{ main_media.file_data|b64encode_blob }}" alt="{{ main_media.file_name }}">
                      {% elif main_media.media_type == 'video' %}
                        <video muted><source src="data:{{ main_media.file_type }};base64,{{ main_media.file_data|b64encode_blob }}" type="{{ main_media.file_type }}"></video>
                      {% else %}
                        <div class="media-main-doc"><i class="bi bi-file-earmark"></i><span>{{ main_media.file_name }}</span></div>
                      {% endif %}
                    {% endwith %}
                  </div>
                  <div class="media-secondary">
                    {% for media in post.media_files.all|slice:"1:3" %}
                      <div class="media-secondary-item" data-media-id="{{ media.id }}">
                        {% if media.media_type == 'image' %}
                          <img src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" alt="{{ media.file_name }}">
                        {% elif media.media_type == 'video' %}
                          <video muted><source src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" type="{{ media.file_type }}"></video>
                        {% else %}
                          <div class="media-secondary-doc"><i class="bi bi-file-earmark"></i></div>
                        {% endif %}
                        {% if forloop.first %}
                          <div class="media-overlay"><div class="media-count">+{{ media_count }}</div></div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endwith %}

          <!-- Hidden: all media with ids for modal use -->
          <div class="all-media-files" style="display:none">
            {% for media in post.media_files.all %}
              {% if media.media_type == 'image' %}
                <img data-media-id="{{ media.id }}" src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" alt="{{ media.file_name }}" data-file-type="{{ media.file_type }}" data-file-name="{{ media.file_name }}" data-file-data="{{ media.file_data|b64encode_blob }}">
              {% elif media.media_type == 'video' %}
                <video data-media-id="{{ media.id }}" muted data-file-type="{{ media.file_type }}" data-file-name="{{ media.file_name }}" data-file-data="{{ media.file_data|b64encode_blob }}"><source src="data:{{ media.file_type }};base64,{{ media.file_data|b64encode_blob }}" type="{{ media.file_type }}"></video>
              {% else %}
                <div class="media-main-doc" data-media-id="{{ media.id }}" data-file-type="{{ media.file_type }}" data-file-name="{{ media.file_name }}" data-file-data="{{ media.file_data|b64encode_blob }}"><i class="bi bi-file-earmark"></i><span>{{ media.file_name }}</span></div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="post-footer">
          <button class="post-action like-btn {% if user in post.likes.all %}liked{% endif %}" data-post-id="{{ post.id }}">
            <i class="bi {% if user in post.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
            <span class="likes-count">{{ post.likes.count }}</span>
          </button>
          <button class="post-action" data-bs-toggle="collapse" data-bs-target="#comments-{{ post.id }}">
            <i class="bi bi-chat"></i>
            <span>{{ post.comments.count }}</span>
          </button>
          <button class="post-action save-btn" data-post-id="{{ post.id }}" title="Save">
            {% if user in post.saved_by.all %}
              <i class="fa fa-bookmark"></i>
            {% else %}
              <i class="fa fa-bookmark-o"></i>
            {% endif %}
          </button>
        </div>

        <div class="collapse comment-section" id="comments-{{ post.id }}">
          <div class="comments-container mb-3" style="max-height:300px; overflow-y:auto;">
            {% for comment in post.comments.all %}
              <div class="comment" id="comment-{{ comment.id }}">
                <div class="d-flex align-items-center mb-2">
                  {% if comment.author|get_profile_image %}
                    <img src="data:image/jpeg;base64,{{ comment.author|get_profile_image|b64encode_blob }}" class="rounded-circle me-2" width="32" height="32">
                  {% else %}
                    <div class="rounded-circle me-2 bg-secondary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px;"><i class="bi bi-person-fill" style="font-size:.875rem"></i></div>
                  {% endif %}
                  <strong>{{ comment.author.get_full_name|default:comment.author.email }}</strong>
                  <small class="text-muted ms-2">{{ comment.created_at|timesince }} ago</small>
                </div>
                <p class="mb-0">{{ comment.content }}</p>
              </div>
            {% empty %}
              <div class="text-muted">No comments yet.</div>
            {% endfor %}
          </div>
          <form class="comment-form" data-post-id="{{ post.id }}">
            {% csrf_token %}
            <div class="input-group">
              <input type="text" name="content" class="form-control" placeholder="Write a comment..." maxlength="500" required>
              <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
            </div>
          </form>
        </div>
      </div>
    {% empty %}
      <div class="text-center text-muted">You haven't posted anything yet.</div>
    {% endfor %}
  </div>
</div>

<!-- Edit Post Modal -->
<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editPostForm">
          {% csrf_token %}
          <input type="hidden" name="post_id" id="editPostId">
          <div class="mb-3">
            <label class="form-label">Content</label>
            <textarea class="form-control" name="content" id="editPostContent" rows="4" maxlength="2000"></textarea>
          </div>
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Media</h6>
            <small class="text-muted">Drag to re-order. Click ✖ to remove.</small>
          </div>
          <div id="modalMediaList" class="modal-media-grid"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="savePostBtn"><i class="bi bi-check2 me-1"></i>Save</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  const userRole = document.body.dataset.userRole;
  const endpoints = {
    edit: (id) => userRole === 'entrepreneur' ? `/entrepreneur/posts/${id}/edit/` : `/investor/posts/${id}/edit/`,
    removeMedia: (postId, mediaId) => userRole === 'entrepreneur' ? `/entrepreneur/posts/${postId}/remove-media/${mediaId}/` : `/investor/posts/${postId}/remove-media/${mediaId}/`,
    reorder: (postId) => userRole === 'entrepreneur' ? `/entrepreneur/posts/${postId}/reorder-media/` : `/investor/posts/${postId}/reorder-media/`
  };

  let removedIds = [];

  // Build modal with media
  const editModal = document.getElementById('editPostModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    removedIds = [];
    const button = event.relatedTarget;
    const postId = button.getAttribute('data-post-id');
    const content = button.getAttribute('data-post-content') || '';
    document.getElementById('editPostId').value = postId;
    document.getElementById('editPostContent').value = content;

    const postEl = document.querySelector(`[data-post-id="${postId}"]`);
    const modalList = document.getElementById('modalMediaList');
    modalList.innerHTML = '';

    const mediaEls = postEl.querySelectorAll('.all-media-files img, .all-media-files video, .all-media-files .media-main-doc');
    mediaEls.forEach(el => {
      const id = el.dataset.mediaId;
      // Build item
      const item = document.createElement('div');
      item.className = 'modal-media-item draggable';
      item.setAttribute('draggable', 'true');
      item.dataset.mediaId = id;
      let inner = '';
      if (el.tagName === 'IMG') {
        inner = `<img src="${el.src}" alt="">`;
      } else if (el.tagName === 'VIDEO') {
        const src = el.querySelector('source')?.src || '';
        const type = el.querySelector('source')?.type || 'video/mp4';
        inner = `<video muted><source src="${src}" type="${type}"></video>`;
      } else {
        inner = `<div class="gallery-doc-thumbnail"><i class="bi bi-file-earmark"></i></div>`;
      }
      item.innerHTML = inner + `<button type="button" class="btn btn-sm btn-danger remove" title="Remove">✖</button>`;
      modalList.appendChild(item);
    });
  });

  // Modal media remove
  document.getElementById('modalMediaList').addEventListener('click', function(e){
    const btn = e.target.closest('.remove');
    if (!btn) return; const item = btn.closest('.modal-media-item');
    removedIds.push(item.dataset.mediaId); item.remove();
  });

  // Drag/drop reordering in modal
  let dragged = null;
  const list = document.getElementById('modalMediaList');
  list.addEventListener('dragstart', e => { const it = e.target.closest('.modal-media-item'); if (!it) return; dragged = it; e.dataTransfer.effectAllowed = 'move'; });
  list.addEventListener('dragover', e => { if (!e.target.closest('.modal-media-item')) return; e.preventDefault(); e.target.closest('.modal-media-item').classList.add('drag-over'); });
  list.addEventListener('dragleave', e => { const it = e.target.closest('.modal-media-item'); if (it) it.classList.remove('drag-over'); });
  list.addEventListener('drop', e => {
    const target = e.target.closest('.modal-media-item'); if (!dragged || !target || dragged===target) return; e.preventDefault(); target.classList.remove('drag-over');
    const container = target.parentNode; const dIdx = Array.from(container.children).indexOf(dragged); const tIdx = Array.from(container.children).indexOf(target);
    if (dIdx < tIdx) container.insertBefore(dragged, target.nextSibling); else container.insertBefore(dragged, target);
  });

  // Save all changes from modal
  document.getElementById('savePostBtn').addEventListener('click', async function(){
    const postId = document.getElementById('editPostId').value;
    const content = document.getElementById('editPostContent').value.trim();
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // 1) Save content
    const editRes = await fetch(endpoints.edit(postId), { method: 'POST', headers: { 'X-CSRFToken': csrf }, body: new URLSearchParams({ content }) });
    const editData = await editRes.json(); if (!editData.success) { alert('Failed to save content'); return; }

    // 2) Remove media (sequentially)
    for (const mid of removedIds) {
      await fetch(endpoints.removeMedia(postId, mid), { method: 'POST', headers: { 'X-CSRFToken': csrf } });
    }

    // 3) Reorder media
    const order = Array.from(document.querySelectorAll('#modalMediaList .modal-media-item')).map(el => el.dataset.mediaId);
    if (order.length) {
      const form = new URLSearchParams(); order.forEach(id => form.append('order[]', id));
      await fetch(endpoints.reorder(postId), { method: 'POST', headers: { 'X-CSRFToken': csrf }, body: form });
    }

    // Done
    const modal = bootstrap.Modal.getInstance(document.getElementById('editPostModal')); if (modal) modal.hide();
    location.reload();
  });
})();
</script>
{% endblock %}
